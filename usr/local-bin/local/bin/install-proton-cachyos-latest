#!/usr/bin/env sh

if [[ -z "$SUDO_USER" ]]; then
  echo "Please run with sudo."
  exit 1
fi

function install_cachyos_proton() {
  OPTIMIZATION=$1

  URL=$(curl -sL https://api.github.com/repos/CachyOS/proton-cachyos/releases/latest |
    jq -r ".assets[] | select(.name? | match(\"proton-cachyos-.*slr-x86_64_$OPTIMIZATION.tar.xz$\")) | .browser_download_url")
  ASSET_LOC="/tmp/$(basename $URL)"

  echo "Downloading $(basename $URL)..."
  if echo $URL | wget -O "$ASSET_LOC" -qi -; then
    DEST="/home/$SUDO_USER/.steam/steam/compatibilitytools.d/proton-cachyos-slr-$OPTIMIZATION-latest"
    rm -rf "$DEST/*"
    mkdir -p "$DEST"

    tar -xf "$ASSET_LOC" -C "$DEST" --strip-components=1
    sed -i -E "s/\"display_name\" \".*\"/\"display_name\" \"proton-cachyos-slr-$OPTIMIZATION-latest\"/" "$DEST/compatibilitytool.vdf"
    chown -R "$SUDO_USER":"$SUDO_USER" "$DEST"

    rm "$ASSET_LOC"
    echo "Installed proton-cachyos-slr-$OPTIMIZATION-latest!"
  fi
}

install_cachyos_proton "v4" &
install_cachyos_proton "v3" &

wait
