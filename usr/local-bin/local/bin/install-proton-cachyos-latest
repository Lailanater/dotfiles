#!/usr/bin/env sh

function set_user_and_home() {
  if [[ -n $SUDO_USER ]]; then
    USER="$SUDO_USER"
  elif [[ -n $LOGNAME ]]; then
    USER="$LOGNAME"
  else
    USER="$(whoami)"
  fi

  HOME="/home/$USER"
}

function install_cachyos_proton() {
  OPTIMIZATION=$1

  URL=$(curl -sL https://api.github.com/repos/CachyOS/proton-cachyos/releases/latest |
    jq -r ".assets[] | select(.name? | match(\"proton-cachyos-.*slr-x86_64_$OPTIMIZATION.tar.xz$\")) | .browser_download_url")
  ASSET_LOC="/tmp/$(basename $URL)"

  echo "Downloading $(basename $URL)..."
  if echo $URL | wget -O "$ASSET_LOC" -qi -; then
    set_user_and_home
    DEST="$HOME/.steam/steam/compatibilitytools.d/proton-cachyos-slr-$OPTIMIZATION-latest"
    rm -rf "$DEST"
    mkdir -p "$DEST"

    tar -xf "$ASSET_LOC" -C "$DEST" --strip-components=1
    sed -i -E "s/\"display_name\" \".*\"/\"display_name\" \"proton-cachyos-slr-$OPTIMIZATION-latest\"/" "$DEST/compatibilitytool.vdf"
    chown -R "$USER":"$USER" "$DEST"

    rm "$ASSET_LOC"
    echo "Installed proton-cachyos-slr-$OPTIMIZATION-latest!"
  fi
}

STEAM_RUNNING_ID=$(pgrep -i ^steam$)
if [[ -n "$STEAM_RUNNING_ID" ]]; then
  echo "Closing steam..."
  kill -s TERM "$STEAM_RUNNING_ID"
fi

install_cachyos_proton "v4" &
install_cachyos_proton "v3" &

wait

if [[ -n "$STEAM_RUNNING_ID" ]]; then
  echo "Reopening steam..."
  steam -silent &>/dev/null &
fi
