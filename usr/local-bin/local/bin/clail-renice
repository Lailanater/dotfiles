#!/usr/bin/env bash

GAME_NAME=$(echo "$@" | awk -F/ '{print $(NF-1)}')
PROCESS_NAME=$(echo "$@" | awk -F/ '{print $NF}' | awk '{print $1}')
FILE="$HOME/dev/cachyos/ananicy-rules/00-default/games/wine_proton.rules"

if (! grep -qr "$PROCESS_NAME" /etc/ananicy.d/00-default/games) && (! grep -q "$PROCESS_NAME" /etc/ananicy.d/00-default/games/clail-blacklist.txt); then
  STORE_URL="https://store.steampowered.com/app/$SteamAppId"

  if [[ $GAME_NAME == The\ * ]]; then
    HEADING="The"
  else
    # Take the first character and force it to upperâ€‘case
    FIRST=${GAME_NAME:0:1}
    HEADING=${FIRST^^}
  fi
  if ! grep -q "^### $HEADING ###$" "$FILE"; then
    HEADING="Non-latin titles"
  fi

  COMMENT_LINE="# $STORE_URL"
  JSON_LINE="{ \"name\": \"$PROCESS_NAME\", \"type\": \"Game\" }"

  if [[ ! -f /etc/ananicy.d/00-default/games/clail.rules ]]; then
    notify-send --urgency=critical --app-name="clail-renice" \
      "Unable to add new game rule clail.rules does not exist and must be created. Run the following command:" \
      "sudo touch /etc/ananicy.d/00-default/games/clail.rules && sudo chown $USER:$USER /etc/ananicy.d/00-default/games/clail.rules"
    exit 1
  fi

  if ! grep -q "$PROCESS_NAME" /etc/ananicy.d/00-default/games/clail.rules; then
    echo -e "\n# $GAME_NAME\n$COMMENT_LINE\n$JSON_LINE" >>/etc/ananicy.d/00-default/games/clail.rules

    notify-send --app-name="clail-renice" --expire-time=20000 "Added ananicy game rule for $GAME_NAME" "$JSON_LINE"
    if systemctl is-active --quiet ananicy-cpp.service; then
      systemctl restart ananicy-cpp.service
    fi
  fi

  if ! grep -q "$PROCESS_NAME" "$FILE"; then
    awk -i inplace \
      -v game="$GAME_NAME" \
      -v heading="$HEADING" \
      -v comment="$COMMENT_LINE" \
      -v json="$JSON_LINE" '
/^###/ && $0 == ("### " heading " ###") {
    print
    print ""
    print "# " game
    print comment
    print json
    next
}
{ print }
' "$FILE"
  fi
fi

exec "$@"
